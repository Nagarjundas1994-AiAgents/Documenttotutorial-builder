<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Documentation Tutorial Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .agent-system {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .agent-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
            text-align: center;
            transition: all 0.3s ease;
        }

        .agent-card.active {
            border-color: #4facfe;
            background: #f0f8ff;
            transform: scale(1.02);
        }

        .agent-card .agent-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .agent-card h4 {
            color: #495057;
            margin-bottom: 5px;
        }

        .agent-card p {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        input[type="url"], select {
            width: 100%;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input[type="url"]:focus, select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .crawl-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .option-group {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .option-group h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .checkbox-group label {
            margin-bottom: 0;
            font-weight: normal;
            font-size: 0.9rem;
        }

        .generate-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
            width: 100%;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }

        .generate-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .processing-section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .processing-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .processing-header h3 {
            color: #495057;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .agent-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .agent-status {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .agent-status.working {
            border-left-color: #feca57;
            background: #fffbf0;
        }

        .agent-status.completed {
            border-left-color: #28a745;
            background: #f0fff4;
        }

        .agent-status.error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .agent-status h4 {
            color: #495057;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .agent-status .status-icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .agent-status .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
            margin: 10px 0;
        }

        .agent-status .progress-fill {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .crawl-stats {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .crawl-stats h4 {
            color: #2c5aa0;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            background: white;
            padding: 15px;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c5aa0;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .found-urls {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .found-urls h5 {
            color: #495057;
            margin-bottom: 10px;
        }

        .url-item {
            padding: 5px 10px;
            margin: 2px 0;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 0.9rem;
            border-left: 3px solid #28a745;
        }

        .url-item.processing {
            border-left-color: #feca57;
        }

        .url-item.error {
            border-left-color: #dc3545;
        }

        .results {
            display: none;
            margin-top: 30px;
        }

        .tutorial-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .tutorial-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
        }

        .tutorial-header h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .tutorial-nav {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }

        .tutorial-nav h4 {
            color: #495057;
            margin-bottom: 15px;
        }

        .nav-sections {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-section {
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .nav-section:hover {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        .nav-section.active {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        .tutorial-body {
            padding: 30px;
            max-height: 600px;
            overflow-y: auto;
        }

        .tutorial-section {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 1px solid #e9ecef;
        }

        .tutorial-section:last-child {
            border-bottom: none;
        }

        .tutorial-section h3 {
            color: #495057;
            font-size: 1.6rem;
            margin-bottom: 20px;
            padding-left: 15px;
            border-left: 4px solid #4facfe;
        }

        .tutorial-section h4 {
            color: #495057;
            font-size: 1.3rem;
            margin: 20px 0 15px 0;
        }

        .tutorial-section p {
            line-height: 1.7;
            margin-bottom: 15px;
            color: #6c757d;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-family: 'Monaco', 'Consolas', monospace;
            overflow-x: auto;
            position: relative;
        }

        .code-block::before {
            content: attr(data-language);
            position: absolute;
            top: 5px;
            right: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #a0aec0;
        }

        .example-box {
            background: #f0f8ff;
            border: 2px solid #4facfe;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        .example-box h4 {
            color: #2c5aa0;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .analogy-box {
            background: #fff8e1;
            border: 2px solid #ffb74d;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        .analogy-box h4 {
            color: #f57c00;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .concept-map {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .download-section {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .download-btn {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(86, 171, 47, 0.3);
        }

        .error-message {
            background: #ffe6e6;
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            padding: 20px;
            color: #d63031;
            margin: 20px 0;
            display: none;
        }

        .completion-stats {
            background: #e8f5e8;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .completion-stats h4 {
            color: #155724;
            margin-bottom: 15px;
        }

        .final-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .final-stat {
            text-align: center;
            background: white;
            padding: 15px;
            border-radius: 8px;
        }

        .final-stat-value {
            font-size: 1.8rem;
            font-weight: 600;
            color: #155724;
        }

        .final-stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .working .status-icon {
            animation: pulse 1.5s infinite;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .agent-grid {
                grid-template-columns: 1fr;
            }
            
            .crawl-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Multi-Agent Documentation Tutorial Generator</h1>
            <p>Comprehensive AI system that scrapes entire documentation websites and creates thorough tutorials</p>
        </div>

        <div class="main-content">
            <div class="agent-system">
                <h3 style="color: #495057; margin-bottom: 20px; text-align: center;">üéØ AI Agent System Overview</h3>
                <div class="agent-grid">
                    <div class="agent-card" id="crawler-agent">
                        <div class="agent-icon">üï∑Ô∏è</div>
                        <h4>Crawler Agent</h4>
                        <p>Discovers and maps all documentation URLs</p>
                    </div>
                    <div class="agent-card" id="content-agent">
                        <div class="agent-icon">üìñ</div>
                        <h4>Content Agent</h4>
                        <p>Extracts and cleans content from each page</p>
                    </div>
                    <div class="agent-card" id="analysis-agent">
                        <div class="agent-icon">üîç</div>
                        <h4>Analysis Agent</h4>
                        <p>Identifies key concepts and relationships</p>
                    </div>
                    <div class="agent-card" id="structure-agent">
                        <div class="agent-icon">üèóÔ∏è</div>
                        <h4>Structure Agent</h4>
                        <p>Organizes content into logical sections</p>
                    </div>
                    <div class="agent-card" id="example-agent">
                        <div class="agent-icon">üí°</div>
                        <h4>Example Agent</h4>
                        <p>Generates code examples and use cases</p>
                    </div>
                    <div class="agent-card" id="tutorial-agent">
                        <div class="agent-icon">‚úçÔ∏è</div>
                        <h4>Tutorial Agent</h4>
                        <p>Creates beginner-friendly explanations</p>
                    </div>
                </div>
            </div>

            <div class="input-section">
                <div class="form-group">
                    <label for="docUrl">üåê Documentation Website URL</label>
                    <input type="url" id="docUrl" placeholder="https://docs.example.com/" required>
                </div>

                <div class="form-group">
                    <label for="crawlDepth">üîç Crawl Depth</label>
                    <select id="crawlDepth">
                        <option value="1">Level 1 - Main sections only</option>
                        <option value="2" selected>Level 2 - All subsections</option>
                        <option value="3">Level 3 - Deep crawl (recommended)</option>
                        <option value="unlimited">Unlimited - Complete site</option>
                    </select>
                </div>

                <div class="crawl-options">
                    <div class="option-group">
                        <h4>üìë Content Types</h4>
                        <div class="checkbox-group">
                            <input type="checkbox" id="includeAPI" checked>
                            <label for="includeAPI">API References</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="includeGuides" checked>
                            <label for="includeGuides">Guides & Tutorials</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="includeExamples" checked>
                            <label for="includeExamples">Code Examples</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="includeFAQs" checked>
                            <label for="includeFAQs">FAQs & Troubleshooting</label>
                        </div>
                    </div>

                    <div class="option-group">
                        <h4>üé® Tutorial Features</h4>
                        <div class="checkbox-group">
                            <input type="checkbox" id="generateAnalogies" checked>
                            <label for="generateAnalogies">Analogies & Metaphors</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="createExercises" checked>
                            <label for="createExercises">Practice Exercises</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="buildConceptMaps" checked>
                            <label for="buildConceptMaps">Concept Maps</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="addSummaries" checked>
                            <label for="addSummaries">Section Summaries</label>
                        </div>
                    </div>

                    <div class="option-group">
                        <h4>‚öôÔ∏è Advanced Options</h4>
                        <div class="checkbox-group">
                            <input type="checkbox" id="respectRobots" checked>
                            <label for="respectRobots">Respect robots.txt</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="followRedirects" checked>
                            <label for="followRedirects">Follow redirects</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="extractMedia">
                            <label for="extractMedia">Include images/diagrams</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="crossReference" checked>
                            <label for="crossReference">Cross-reference topics</label>
                        </div>
                    </div>
                </div>

                <button class="generate-btn" onclick="startComprehensiveGeneration()">
                    üöÄ Start Comprehensive Analysis
                </button>
            </div>

            <div class="processing-section" id="processingSection">
                <div class="processing-header">
                    <h3>üîÑ Multi-Agent Processing in Progress</h3>
                    <p>Our AI agents are working together to create your comprehensive tutorial</p>
                </div>

                <div class="crawl-stats" id="crawlStats">
                    <h4>üìä Crawling Statistics</h4>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="urlsFound">0</div>
                            <div class="stat-label">URLs Found</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="urlsProcessed">0</div>
                            <div class="stat-label">Processed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="conceptsExtracted">0</div>
                            <div class="stat-label">Concepts</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="examplesFound">0</div>
                            <div class="stat-label">Examples</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="sectionsCreated">0</div>
                            <div class="stat-label">Sections</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalWords">0</div>
                            <div class="stat-label">Total Words</div>
                        </div>
                    </div>
                </div>

                <div class="agent-status-grid">
                    <div class="agent-status" id="crawler-status">
                        <h4><span class="status-icon">üï∑Ô∏è</span>Crawler Agent</h4>
                        <p id="crawler-message">Initializing...</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="crawler-progress"></div>
                        </div>
                    </div>
                    <div class="agent-status" id="content-status">
                        <h4><span class="status-icon">üìñ</span>Content Agent</h4>
                        <p id="content-message">Waiting for URLs...</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="content-progress"></div>
                        </div>
                    </div>
                    <div class="agent-status" id="analysis-status">
                        <h4><span class="status-icon">üîç</span>Analysis Agent</h4>
                        <p id="analysis-message">Waiting for content...</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="analysis-progress"></div>
                        </div>
                    </div>
                    <div class="agent-status" id="structure-status">
                        <h4><span class="status-icon">üèóÔ∏è</span>Structure Agent</h4>
                        <p id="structure-message">Waiting for analysis...</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="structure-progress"></div>
                        </div>
                    </div>
                    <div class="agent-status" id="example-status">
                        <h4><span class="status-icon">üí°</span>Example Agent</h4>
                        <p id="example-message">Waiting for structure...</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="example-progress"></div>
                        </div>
                    </div>
                    <div class="agent-status" id="tutorial-status">
                        <h4><span class="status-icon">‚úçÔ∏è</span>Tutorial Agent</h4>
                        <p id="tutorial-message">Waiting for examples...</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="tutorial-progress"></div>
                        </div>
                    </div>
                </div>

                <div class="found-urls" id="foundUrls" style="display: none;">
                    <h5>üîó Discovered URLs</h5>
                    <div id="urlList"></div>
                </div>
            </div>

            <div class="completion-stats" id="completionStats">
                <h4>‚úÖ Tutorial Generation Complete!</h4>
                <div class="final-stats-grid">
                    <div class="final-stat">
                        <div class="final-stat-value" id="finalPages">0</div>
                        <div class="final-stat-label">Pages Analyzed</div>
                    </div>
                    <div class="final-stat">
                        <div class="final-stat-value" id="finalConcepts">0</div>
                        <div class="final-stat-label">Key Concepts</div>
                    </div>
                    <div class="final-stat">
                        <div class="final-stat-value" id="finalExamples">0</div>
                        <div class="final-stat-label">Code Examples</div>
                    </div>
                    <div class="final-stat">
                        <div class="final-stat-value" id="finalSections">0</div>
                        <div class="final-stat-label">Tutorial Sections</div>
                    </div>
                    <div class="final-stat">
                        <div class="final-stat-value" id="finalWords">0</div>
                        <div class="final-stat-label">Words Generated</div>
                    </div>
                    <div class="final-stat">
                        <div class="final-stat-value" id="processingTime">0</div>
                        <div class="final-stat-label">Minutes</div>
                    </div>
                </div>
            </div>

            <div class="error-message" id="errorMessage"></div>

            <div class="results" id="results">
                <div class="tutorial-content">
                    <div class="tutorial-header">
                        <h2 id="tutorialTitle">Comprehensive Tutorial Generated</h2>
                        <p id="tutorialDescription">Complete documentation analysis and beginner-friendly guide</p>
                    </div>
                    <div class="tutorial-nav">
                        <h4>üìö Tutorial Sections</h4>
                        <div class="nav-sections" id="navSections">
                            <!-- Navigation will be generated dynamically -->
                        </div>
                    </div>
                    <div class="tutorial-body" id="tutorialBody">
                        <!-- Generated tutorial content will be inserted here -->
                    </div>
                </div>
                
                <div class="download-section">
                    <h4>üì• Download Your Complete Tutorial</h4>
                    <p>Export in multiple formats for offline reading and reference</p>
                    <button class="download-btn" onclick="downloadTutorial('md')">üìù Markdown</button>
                    <button class="download-btn" onclick="downloadTutorial('html')">üåê HTML</button>
                    <button class="download-btn" onclick="downloadTutorial('pdf')">üìÑ PDF</button>
                    <button class="download-btn" onclick="downloadTutorial('epub')">üìö EPUB</button>
                    <button class="download-btn" onclick="downloadTutorial('json')">üìä JSON Data</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let tutorialData = null;
        let stats = {
            urlsFound: 0,
            urlsProcessed: 0,
            conceptsExtracted: 0,
            examplesFound: 0,
            sectionsCreated: 0,
            totalWords: 0
        };
        let processingStart = null;
        let socket = null;

        // --- UI Helpers ---
        function showSection(id) {
            document.getElementById('processingSection').style.display = 'none';
            document.getElementById('completionStats').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            if (id) {
                document.getElementById(id + 'Section').style.display = 'block';
            }
        }
        function updateStatsUI() {
            Object.keys(stats).forEach(key => {
                const el = document.getElementById(key);
                if (el) el.textContent = stats[key];
            });
        }
        function updateFinalStatsUI() {
            document.getElementById('finalPages').textContent = stats.urlsProcessed;
            document.getElementById('finalConcepts').textContent = stats.conceptsExtracted;
            document.getElementById('finalExamples').textContent = stats.examplesFound;
            document.getElementById('finalSections').textContent = stats.sectionsCreated;
            document.getElementById('finalWords').textContent = stats.totalWords;
            if (processingStart) {
                const mins = Math.round((Date.now() - processingStart) / 60000);
                document.getElementById('processingTime').textContent = mins;
            }
        }
        function updateAgentStatus(agent, status, progress, message) {
            const statusDiv = document.getElementById(agent+'-status');
            if (!statusDiv) return;
            statusDiv.className = 'agent-status ' + (status === 'working' ? 'working' : status === 'completed' ? 'completed' : status === 'error' ? 'error' : '');
            document.getElementById(agent+'-message').textContent = message;
            document.getElementById(agent+'-progress').style.width = progress + '%';
        }
        function showError(msg) {
            const err = document.getElementById('errorMessage');
            err.textContent = `Error: ${msg}`;
            err.style.display = 'block';
            document.querySelector('.generate-btn').disabled = false;
        }
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // --- Main Generation Logic ---
        function startComprehensiveGeneration() {
            hideError();
            const url = document.getElementById('docUrl').value;
            if (!url) {
                showError("Please enter a valid URL.");
                return;
            }

            // Reset state
            stats = {urlsFound:0,urlsProcessed:0,conceptsExtracted:0,examplesFound:0,sectionsCreated:0,totalWords:0};
            processingStart = Date.now();
            updateStatsUI();
            ['crawler','content','analysis','structure','example','tutorial'].forEach(agent => updateAgentStatus(agent,'idle',0,'Initializing...'));
            showSection('processing');
            document.querySelector('.generate-btn').disabled = true;

            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(`${wsProtocol}//${window.location.host}/ws`);

            socket.onopen = () => {
                console.log("WebSocket connection established.");
                const request = {
                    url: url,
                    depth: document.getElementById('crawlDepth').value
                };
                socket.send(JSON.stringify(request));
            };

            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                console.log("Received message:", msg);

                switch (msg.type) {
                    case 'status':
                        updateAgentStatus(msg.agent, msg.status, msg.progress, msg.message);
                        break;
                    case 'stats_update':
                        stats = { ...stats, ...msg.stats };
                        updateStatsUI();
                        break;
                    case 'result':
                        showSection('completion');
                        updateFinalStatsUI();
                        setTimeout(() => {
                            showSection('results');
                            renderTutorial(msg.data);
                        }, 1200);
                        document.querySelector('.generate-btn').disabled = false;
                        socket.close();
                        break;
                    case 'error':
                        showError(msg.message);
                        document.querySelector('.generate-btn').disabled = false;
                        socket.close();
                        break;
                }
            };

            socket.onerror = (error) => {
                console.error("WebSocket Error:", error);
                showError("Connection failed. Please ensure the server is running.");
                document.querySelector('.generate-btn').disabled = false;
            };

            socket.onclose = () => {
                console.log("WebSocket connection closed.");
                document.querySelector('.generate-btn').disabled = false;
            };
        }

        // --- Render Tutorial ---
        function renderTutorial(data) {
            tutorialData = data;
            document.getElementById('tutorialTitle').textContent = tutorialData.title;
            document.getElementById('tutorialDescription').textContent = tutorialData.description;
            
            const nav = document.getElementById('navSections');
            const body = document.getElementById('tutorialBody');
            nav.innerHTML = '';
            body.innerHTML = '';

            tutorialData.sections.forEach((section, idx) => {
                const sectionId = `section-${idx}`;
                
                // Navigation
                const btn = document.createElement('div');
                btn.className = 'nav-section' + (idx === 0 ? ' active' : '');
                btn.textContent = section.title;
                btn.onclick = () => {
                    document.getElementById(sectionId).scrollIntoView({ behavior: 'smooth' });
                    // Update active nav item
                    document.querySelectorAll('.nav-section').forEach(el => el.classList.remove('active'));
                    btn.classList.add('active');
                };
                nav.appendChild(btn);

                // Body Content
                const div = document.createElement('div');
                div.id = sectionId;
                div.className = 'tutorial-section';
                // Basic markdown to HTML conversion
                let htmlContent = section.content
                    .replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => `<div class="code-block" data-language="${lang || ''}"><pre><code>${code.replace(/</g, '<').replace(/>/g, '>')}</code></pre></div>`)
                    .replace(/`([^`]+)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br>');

                div.innerHTML = `<h3>${section.title}</h3><p>${htmlContent}</p>`;
                body.appendChild(div);
            });
        }

        // --- Download Functionality (Simulated) ---
        function downloadTutorial(format) {
            if (!tutorialData) {
                showError('No tutorial data to download!');
                return;
            }
            // This part remains the same as your original code
            let content = '';
            let filename = 'tutorial.' + format;
            if (format === 'md') {
                content = `# ${tutorialData.title}\n\n${tutorialData.description}\n\n` +
                    tutorialData.sections.map(s => `## ${s.title}\n${s.content}`).join('\n\n');
            } else if (format === 'html') {
                content = `<h1>${tutorialData.title}</h1><p>${tutorialData.description}</p>` +
                    tutorialData.sections.map(s => `<h2>${s.title}</h2><div>${s.content.replace(/\n/g, '<br>')}</div>`).join('');
            } else if (format === 'json') {
                content = JSON.stringify(tutorialData, null, 2);
            } else if (format === 'pdf' || format === 'epub') {
                showError('PDF/EPUB export is not implemented in this demo.');
                return;
            }
            const blob = new Blob([content], {type: 'text/plain;charset=utf-8'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>